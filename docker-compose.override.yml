# ============================================
# MSIA Docker Compose 开发环境覆盖配置
# 用于本地开发时覆盖默认配置
# ============================================

version: '3.8'

services:
  db:
    ports:
      - "5432:5432"
    # 开发环境可以查看数据库日志
    command: postgres -c log_statement=all -c log_destination=stderr

  redis:
    ports:
      - "6379:6379"

  server:
    build:
      target: builder  # 使用构建阶段，包含开发依赖
    volumes:
      - ./server/src:/app/src:ro
      - ./server/prisma:/app/prisma:ro
      - uploads_data:/app/uploads
      - ./server/knowledge_base:/app/knowledge_base:ro
    environment:
      NODE_ENV: development
      LOG_LEVEL: debug
      REDIS_URL: redis://redis:6379
      AUTH_LOGIN_IP_WINDOW_MS: ${AUTH_LOGIN_IP_WINDOW_MS:-60000}
      AUTH_LOGIN_IP_MAX: ${AUTH_LOGIN_IP_MAX:-30}
      AUTH_LOGIN_FAIL_WINDOW_MS: ${AUTH_LOGIN_FAIL_WINDOW_MS:-600000}
      AUTH_LOGIN_FAIL_WINDOW_MODE: ${AUTH_LOGIN_FAIL_WINDOW_MODE:-fixed}
      AUTH_LOGIN_MAX_FAILS_DOCTOR: ${AUTH_LOGIN_MAX_FAILS_DOCTOR:-5}
      AUTH_LOGIN_LOCK_MS_DOCTOR: ${AUTH_LOGIN_LOCK_MS_DOCTOR:-600000}
      AUTH_LOGIN_MAX_FAILS_ADMIN: ${AUTH_LOGIN_MAX_FAILS_ADMIN:-5}
      AUTH_LOGIN_LOCK_MS_ADMIN: ${AUTH_LOGIN_LOCK_MS_ADMIN:-600000}
      AUTH_LOGIN_SLIDING_REFRESH_TTL: ${AUTH_LOGIN_SLIDING_REFRESH_TTL:-true}
      AUTH_REGISTER_IP_WINDOW_MS: ${AUTH_REGISTER_IP_WINDOW_MS:-600000}
      AUTH_REGISTER_IP_MAX: ${AUTH_REGISTER_IP_MAX:-20}
    # 开发模式使用热重载
    command: ["npm", "run", "dev"]

  client:
    build:
      target: builder
    volumes:
      - ./client/src:/app/src:ro
      - ./client/public:/app/public:ro
      - ./client/index.html:/app/index.html:ro
      - ./client/certs:/etc/nginx/certs:ro
    ports:
      - "8000:8000"
      - "443:443"
    # 开发模式使用 Vite 开发服务器
    command: ["npm", "run", "dev"]

  # 可选：使用 Nginx 启动前端（生产方式），通过 profile 启用
  client-nginx:
    profiles:
      - nginx
    image: msia-client-prod:latest
    container_name: msia_client_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./client/certs:/etc/nginx/certs:ro
    depends_on:
      - server
