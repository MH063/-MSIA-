import { Request, Response } from 'express';
import prisma from '../prisma';

// 症状同义词映射配置 - 基于 knowledge_base 目录下的所有症状
export const SYMPTOM_SYNONYMS: Record<string, string> = {
  // 腹痛相关
  '肚子疼': '腹痛',
  '肚子痛': '腹痛',
  '腹疼': '腹痛',
  '胃疼': '腹痛',
  '胃痛': '腹痛',
  '上腹痛': '腹痛',
  '下腹痛': '腹痛',
  '腹部不适': '腹痛',
  // 口语化、地域化表达
  '绞肠痧': '腹痛',
  '心口窝疼': '腹痛',
  '岔气': '腹痛',
  '肚子不舒服': '腹痛',
  // 焦虑相关
  '焦慮': '焦虑',
  '紧张': '焦虑',
  '担心': '焦虑',
  '不安': '焦虑',
  '烦躁': '焦虑',
  '恐懼': '焦虑',
  // 关节痛相关
  '关节疼': '关节痛',
  '关节疼痛': '关节痛',
  '关节不适': '关节痛',
  '关节肿胀': '关节痛',
  '关节红肿': '关节痛',
  // 胸痛相关
  '胸口疼': '胸痛',
  '胸口痛': '胸痛',
  '胸疼': '胸痛',
  '胸部不适': '胸痛',
  '心口疼': '胸痛',
  '心口痛': '胸痛',
  // 便秘相关
  '排便困难': '便秘',
  '大便干结': '便秘',
  '排便不畅': '便秘',
  '几天没大便': '便秘',
  // 咳嗽相关
  '咳嗽': '咳嗽与咳痰',
  '咳痰': '咳嗽与咳痰',
  '咳': '咳嗽与咳痰',
  '干咳': '咳嗽与咳痰',
  '有痰': '咳嗽与咳痰',
  // 医学细分术语
  '呛咳': '咳嗽与咳痰',
  '犬吠样咳嗽': '咳嗽与咳痰',
  // 发绀相关
  '青紫': '发绀',
  '嘴唇发紫': '发绀',
  '指甲发紫': '发绀',
  '缺氧': '发绀',
  '口唇青紫': '发绀',
  // 抑郁相关
  '抑鬱': '抑郁',
  '情绪低落': '抑郁',
  '心情差': '抑郁',
  '不开心': '抑郁',
  '郁闷': '抑郁',
  '沮丧': '抑郁',
  // 腹泻相关
  '拉肚子': '腹泻',
  '拉稀': '腹泻',
  '大便稀': '腹泻',
  '水样便': '腹泻',
  // 口语化、地域化表达
  '窜稀': '腹泻',
  '跑肚': '腹泻',
  '拉水': '腹泻',
  // 意识障碍相关
  '意识不清': '意识障碍',
  '昏迷': '意识障碍',
  '嗜睡': '意识障碍',
  '昏睡': '意识障碍',
  '神志不清': '意识障碍',
  '迷糊': '意识障碍',
  // 医学细分术语
  '谵妄': '意识障碍',
  // 吞咽困难相关
  '咽不下去': '吞咽困难',
  '吞咽不适': '吞咽困难',
  '吃东西卡': '吞咽困难',
  // 呼吸困难相关
  '气短': '呼吸困难',
  '喘不上气': '呼吸困难',
  '呼吸急促': '呼吸困难',
  '憋气': '呼吸困难',
  '胸闷气短': '呼吸困难',
  // 医学细分术语
  '端坐呼吸': '呼吸困难',
  '夜间阵发性呼吸困难': '呼吸困难',
  // 排尿困难相关
  '排尿困难': '排尿困难与尿潴留',
  '尿不出来': '排尿困难与尿潴留',
  '尿潴留': '排尿困难与尿潴留',
  '小便困难': '排尿困难与尿潴留',
  // 水肿相关
  '浮肿': '水肿',
  '肿胀': '水肿',
  '脚肿': '水肿',
  '腿肿': '水肿',
  '脸肿': '水肿',
  // 医学细分术语
  '凹陷性水肿': '水肿',
  // 消瘦相关
  '瘦': '消瘦',
  '体重下降': '消瘦',
  '变瘦了': '消瘦',
  '体重减轻': '消瘦',
  // 发热相关
  '发烧': '发热',
  '高烧': '发热',
  '低烧': '发热',
  '体温高': '发热',
  // 口语化、地域化表达
  '浑身发烫': '发热',
  '害热': '发热',
  '起烧': '发热',
  // 头痛相关
  '头疼': '头痛',
  '头胀': '头痛',
  '头晕头痛': '头痛',
  // 医学细分术语（疼痛性质描述）
  '针扎样痛': '头痛',
  '搏动性痛': '头痛',
  '刺痛': '头痛',
  '胀痛': '头痛',
  // 呕血相关
  '吐血丝': '呕血',
  '吐血': '呕血',
  '呕吐血': '呕血',
  // 便血相关
  '拉血': '便血',
  '大便带血': '便血',
  '血便': '便血',
  '黑便': '便血',
  // 血尿相关
  '尿血': '血尿',
  '小便带血': '血尿',
  '尿液发红': '血尿',
  // 咯血相关
  '咳血': '咯血',
  '痰中带血': '咯血',
  '吐血痰': '咯血',
  // 黄疸相关
  '皮肤黄': '黄疸',
  '眼白发黄': '黄疸',
  '尿黄': '黄疸',
  '皮肤发黄': '黄疸',
  // 腰背痛相关
  '腰疼': '腰背痛',
  '腰痛': '腰背痛',
  '后背疼': '腰背痛',
  '背痛': '腰背痛',
  '腰酸': '腰背痛',
  // 皮肤黏膜出血相关
  '皮肤出血': '皮肤黏膜出血',
  '黏膜出血': '皮肤黏膜出血',
  '瘀斑': '皮肤黏膜出血',
  '紫癜': '皮肤黏膜出血',
  '淤青': '皮肤黏膜出血',
  '皮下出血': '皮肤黏膜出血',
  // 恶心与呕吐相关
  '恶心': '恶心与呕吐',
  '呕吐': '恶心与呕吐',
  '想吐': '恶心与呕吐',
  '反胃': '恶心与呕吐',
  '吐': '恶心与呕吐',
  // 口语化、地域化表达
  '干哕': '恶心与呕吐',
  '反酸水': '恶心与呕吐',
  // 肥胖相关
  '胖': '肥胖',
  '超重': '肥胖',
  '体重超标': '肥胖',
  // 少尿无尿多尿相关
  '少尿': '少尿、无尿和多尿',
  '无尿': '少尿、无尿和多尿',
  '多尿': '少尿、无尿和多尿',
  '尿少': '少尿、无尿和多尿',
  '尿多': '少尿、无尿和多尿',
  '尿频': '少尿、无尿和多尿',
  // 心悸相关
  '心慌': '心悸',
  '心跳快': '心悸',
  '心律不齐': '心悸',
  '心乱跳': '心悸',
  // 医学细分术语
  '心脏停跳感': '心悸',
  '心里咯噔一下': '心悸',
  // 晕厥相关
  '晕倒': '晕厥',
  '昏倒': '晕厥',
  '晕过去': '晕厥',
  '失去意识': '晕厥',
  // 抽搐与惊厥相关
  '抽搐': '抽搐与惊厥',
  '惊厥': '抽搐与惊厥',
  '抽筋': '抽搐与惊厥',
  '痉挛': '抽搐与惊厥',
  '癫痫': '抽搐与惊厥',
  '抽风': '抽搐与惊厥',
  // 尿频尿急尿痛相关
  '尿频尿急': '尿频、尿急、尿痛',
  '尿急': '尿频、尿急、尿痛',
  '尿痛': '尿频、尿急、尿痛',
  '小便频': '尿频、尿急、尿痛',
  '小便急': '尿频、尿急、尿痛',
  '小便疼': '尿频、尿急、尿痛',
  // 尿失禁相关
  '漏尿': '尿失禁',
  '控制不住小便': '尿失禁',
  '尿裤子': '尿失禁',
  // 眩晕相关
  '头晕': '眩晕',
  '头昏': '眩晕',
  '天旋地转': '眩晕',
  '头重脚轻': '眩晕',
  // 口语化、地域化表达
  '发晕': '眩晕',
  '眼前发黑': '眩晕',
};

export const getSymptomMappings = async (_req: Request, res: Response) => {
  try {
    console.log('[Mapping] 开始获取症状映射');
    
    // 从数据库获取症状知识库数据
    const symptomKnowledge = await prisma.symptomKnowledge.findMany({
      select: {
        symptomKey: true,
        displayName: true
      }
    });

    console.log('[Mapping] 从数据库获取到症状数据数量:', symptomKnowledge.length);

    // 构建 nameToKey 映射
    const nameToKey: Record<string, string> = {};

    symptomKnowledge.forEach(sk => {
      // 主名称映射
      if (sk.displayName && sk.symptomKey) {
        nameToKey[sk.displayName] = sk.symptomKey;
      }
    });

    // 添加同义词映射（只添加存在于数据库中的症状）
    const synonyms: Record<string, string> = {};
    for (const [synonym, canonicalName] of Object.entries(SYMPTOM_SYNONYMS)) {
      if (nameToKey[canonicalName]) {
        synonyms[synonym] = canonicalName;
      }
    }

    console.log('[Mapping] 构建的映射数据数量:', Object.keys(nameToKey).length);
    console.log('[Mapping] 同义词映射数量:', Object.keys(synonyms).length);

    res.json({
      success: true,
      data: {
        synonyms,
        nameToKey
      }
    });
  } catch (error) {
    console.error('获取症状映射失败:', error);
    res.status(500).json({
      success: false,
      message: '获取症状映射失败'
    });
  }
};
